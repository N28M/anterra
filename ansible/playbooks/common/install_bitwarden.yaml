---
- name: Install and Configure Bitwarden for Ansible
  hosts: rpi
  become: true
  gather_facts: true

  tasks:
    - name: Install build dependencies and Python packages
      apt:
        name:
          - build-essential
          - python3-pip
          - python3-venv
          - python3-dev
          - cargo
          - rustc
          - git
          - wget
          - unzip
        state: present
        update_cache: yes

    - name: Create Python virtual environment for bitwarden
      command: python3 -m venv /opt/bitwarden_venv
      args:
        creates: /opt/bitwarden_venv

    - name: Upgrade pip in virtual environment
      pip:
        name: pip
        state: latest
        virtualenv: /opt/bitwarden_venv

    - name: Check if bitwarden-sdk is already installed
      command: "{{ ansible_python_interpreter | default('python3') }} -c 'import bitwarden_sdk'"
      environment:
        PYTHONPATH: /opt/bitwarden_venv/lib/python3.13/site-packages
      register: bitwarden_check
      failed_when: false
      changed_when: false

    - name: Install bitwarden-sdk on ARM64 with LICENSE file workaround
      when:
        - bitwarden_check.rc != 0
        - ansible_architecture in ['aarch64', 'armv7l']
      block:
        - name: Create temporary directory for bitwarden-sdk build
          tempfile:
            state: directory
          register: bitwarden_tmpdir

        - name: Download bitwarden-sdk source tarball
          get_url:
            url: "https://files.pythonhosted.org/packages/dd/03/11934ae9d668283895286872a7af3de25d324ec9ac86da5a56ac9dc48544/bitwarden_sdk-1.0.0.tar.gz"
            dest: "{{ bitwarden_tmpdir.path }}/bitwarden_sdk-1.0.0.tar.gz"
            mode: '0644'

        - name: Extract bitwarden-sdk tarball
          unarchive:
            src: "{{ bitwarden_tmpdir.path }}/bitwarden_sdk-1.0.0.tar.gz"
            dest: "{{ bitwarden_tmpdir.path }}"
            remote_src: yes

        - name: Download missing LICENSE file
          get_url:
            url: "https://raw.githubusercontent.com/bitwarden/sdk/refs/heads/main/LICENSE"
            dest: "{{ bitwarden_tmpdir.path }}/bitwarden_sdk-1.0.0/LICENSE"
            mode: '0644'

        - name: Install bitwarden-sdk from fixed source
          pip:
            name: "{{ bitwarden_tmpdir.path }}/bitwarden_sdk-1.0.0"
            virtualenv: /opt/bitwarden_venv

        - name: Clean up temporary directory
          file:
            path: "{{ bitwarden_tmpdir.path }}"
            state: absent
      rescue:
        - name: Display error message if ARM64 installation fails
          debug:
            msg: "Failed to install bitwarden-sdk on ARM64. Check the error above for details."

    - name: Install bitwarden-sdk on x86_64 via pip
      when:
        - bitwarden_check.rc != 0
        - ansible_architecture == 'x86_64'
      pip:
        name: bitwarden-sdk
        virtualenv: /opt/bitwarden_venv

    - name: Display instructions for installing bitwarden.secrets collection
      debug:
        msg: |
          Please finish the setup by installing the ansible collection on the host using: ansible-galaxy collection install bitwarden.secrets